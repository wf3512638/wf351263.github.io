<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>15.keepalived高可用 | WF's Blog</title><meta name="description" content="15.keepalived高可用"><meta name="keywords" content="keepalived"><meta name="author" content="Wu Fei"><meta name="copyright" content="Wu Fei"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="15.keepalived高可用"><meta name="twitter:description" content="15.keepalived高可用"><meta name="twitter:image" content="http://linuxwf.com/img/63060960_p0.jpg"><meta property="og:type" content="article"><meta property="og:title" content="15.keepalived高可用"><meta property="og:url" content="http://linuxwf.com/2020/04/13/15-keepalived/"><meta property="og:site_name" content="WF's Blog"><meta property="og:description" content="15.keepalived高可用"><meta property="og:image" content="http://linuxwf.com/img/63060960_p0.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://linuxwf.com/2020/04/13/15-keepalived/"><link rel="prev" title="16.HTTPS域名证书" href="http://linuxwf.com/2020/04/13/16-HTTPS%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6/"><link rel="next" title="14.反向代理负载均衡" href="http://linuxwf.com/2020/04/13/14-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?bf8fa809dbe0a82b3d983accb9d256fe";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"GQXJKQPX6A","apiKey":"9d6901decfc3e9736a8f99965d4fc700","indexName":"my_blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="WF's Blog" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">63</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">46</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/video/"><i class="fa-fw fa fa-video"></i><span> 视频</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw far fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fa fa-book"></i><span> 书籍</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fa fa-gamepad"></i><span> Game</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#keepalived高可用"><span class="toc-number">1.</span> <span class="toc-text">keepalived高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第1章-keepalived介绍"><span class="toc-number">1.1.</span> <span class="toc-text">第1章 keepalived介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第2章-keepalived服务的重要功能"><span class="toc-number">1.2.</span> <span class="toc-text">第2章 keepalived服务的重要功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-作为系统网络服务的高可用功能-failover"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 作为系统网络服务的高可用功能(failover)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-什么是VRRP"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 什么是VRRP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-面试的时候怎么说"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 面试的时候怎么说</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第3章-keepalived高可用服务搭建准备"><span class="toc-number">1.3.</span> <span class="toc-text">第3章 keepalived高可用服务搭建准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-安装keepalived环境说明"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 安装keepalived环境说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-安装keepalived软件"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 安装keepalived软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-启动keepalived服务并检查"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 启动keepalived服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-keepalived配置文件说明"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 keepalived配置文件说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第4章-配置keepalived实现单IP自动漂移接管"><span class="toc-number">1.4.</span> <span class="toc-text">第4章 配置keepalived实现单IP自动漂移接管</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-实战配置keepalived主服务器lb01-MASTER"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 实战配置keepalived主服务器lb01 MASTER</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-实战配置keepalived备服务器lb02-BACKUP"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 实战配置keepalived备服务器lb02 BACKUP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-出现裂脑后的排查"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 出现裂脑后的排查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-进行高可用主备服务器切换"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 进行高可用主备服务器切换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-单实例主备模式keeplibed配置文件对比"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5 单实例主备模式keeplibed配置文件对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第5章-keepalived高可用服务器的裂脑问题"><span class="toc-number">1.5.</span> <span class="toc-text">第5章 keepalived高可用服务器的裂脑问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-什么是裂脑"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 什么是裂脑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-导致裂脑发生的原因"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2 导致裂脑发生的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-解决裂脑的常见方法"><span class="toc-number">1.5.3.</span> <span class="toc-text">5.3 解决裂脑的常见方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-解决keepalived裂脑的常见方案"><span class="toc-number">1.5.4.</span> <span class="toc-text">5.4 解决keepalived裂脑的常见方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-模拟keepalived裂脑场景"><span class="toc-number">1.5.5.</span> <span class="toc-text">5.5 模拟keepalived裂脑场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第6章-Nginx负载均衡配合keepalived双主模式实战"><span class="toc-number">1.6.</span> <span class="toc-text">第6章 Nginx负载均衡配合keepalived双主模式实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-配置keepalived双主"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 配置keepalived双主</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-Nginx负载均衡"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 Nginx负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-重启nginx和keepalived"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 重启nginx和keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-配置windows解析"><span class="toc-number">1.6.4.</span> <span class="toc-text">6.4 配置windows解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-访问测试"><span class="toc-number">1.6.5.</span> <span class="toc-text">6.5 访问测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-模拟keepalived故障"><span class="toc-number">1.6.6.</span> <span class="toc-text">6.6 模拟keepalived故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-恢复lb01的keelived服务"><span class="toc-number">1.6.7.</span> <span class="toc-text">6.7 恢复lb01的keelived服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第7章-开发监控keepalived裂脑的脚本"><span class="toc-number">1.7.</span> <span class="toc-text">第7章  开发监控keepalived裂脑的脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-lb01检查web脚本"><span class="toc-number">1.7.1.</span> <span class="toc-text">7.1 lb01检查web脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-lb02脚本"><span class="toc-number">1.7.2.</span> <span class="toc-text">7.2 lb02脚本</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/63060960_p0.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">WF's Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/video/"><i class="fa-fw fa fa-video"></i><span> 视频</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw far fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fa fa-book"></i><span> 书籍</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fa fa-gamepad"></i><span> Game</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa-fw fa fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">15.keepalived高可用</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-13 15:21:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-13</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-04-13 15:22:10"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-13</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/LNMP/">LNMP</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon far fa-file-word" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">6.1k</span><span class="post-meta__separator">|</span><i class="post-meta__icon far fa-clock" aria-hidden="true"></i><span>阅读时长: 23 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon far fa-comments" aria-hidden="true"></i><span>评论数:</span><a href="/2020/04/13/15-keepalived/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/04/13/15-keepalived/" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="keepalived高可用"><a href="#keepalived高可用" class="headerlink" title="keepalived高可用"></a>keepalived高可用</h1><h2 id="第1章-keepalived介绍"><a href="#第1章-keepalived介绍" class="headerlink" title="第1章 keepalived介绍"></a>第1章 keepalived介绍</h2><p><code>keepalived</code>软件起初是专为LVS负载均衡软件设计的,用来管理并监控LVS集群系统中各个服务节点状态,后来又加入了可以实现高可用的VRRP功能.此,keepalived除了能够管理LVS软件外,还可以作为其他服务(例如:Nginx,Haproxy,MySQL等)的高可用解决方案软件.</p>
<p><code>keepalived</code>软件主要是通过<code>VRRP</code>协议实现高可用功能的.<code>VRRP</code>是<code>Virtual Router Redundancy</code> Protocol(虚拟路由器冗余协议)的缩写,VRRP出现的目的就是为了解决静态路由单点故障问题的,他能够保证当个别节点宕机时,整个网络可以不间断地运行.Keepalived一方面具有配置管理LVS的功能,同时还具有对LVS下面节点进行健康检查的功能,另一方面也可实现系统网络服务的高可用功能,</p>
<h2 id="第2章-keepalived服务的重要功能"><a href="#第2章-keepalived服务的重要功能" class="headerlink" title="第2章 keepalived服务的重要功能"></a>第2章 keepalived服务的重要功能</h2><h3 id="2-1-作为系统网络服务的高可用功能-failover"><a href="#2-1-作为系统网络服务的高可用功能-failover" class="headerlink" title="2.1 作为系统网络服务的高可用功能(failover)"></a>2.1 作为系统网络服务的高可用功能(failover)</h3><p><code>keepalived</code>可以实现任意两台主机之间,例如Master和Backup主机之间的故障转移和自动切换,这个主机可以使普通的不能停机的业务服务器,也可以是LVS负载均衡,Nginx反向代理这样的服务器.</p>
<p><code>keepalived</code>高可用功能实现的基本原理为:<br> 两台主机同时安装好keepalived软件并启动服务,开始正常工作时<br> 角色为Master的主机获得所有资源并对用户提供服务<br> 角色为Backup的主机作为Master主机的热备;</p>
<p>当角色为Master的主机失效或出现故障时<br> 角色为Backup的主机将自动接管Master主机的所有工作,包括接管VIP资源及相应资源服务</p>
<p>而当角色为Master的主机故障修复后,又会自动接管回他原来处理的工作<br> 角色为Backup的主机则同时释放Master主机失效时他接管的工作<br> 此时,两台主机将恢复到启动时各自的原始角色及工作状态</p>
<h3 id="2-2-什么是VRRP"><a href="#2-2-什么是VRRP" class="headerlink" title="2.2 什么是VRRP"></a>2.2 什么是VRRP</h3><p><code>VRRP</code>,全称<code>Virtual Router Redundancy Protocol</code>,中文名为<code>虚拟路由冗余协议</code><br> <code>VRRP</code>的出现就是为了解决静态路由的单点故障问题<br> <code>VRRP</code>是通过一种竞选机制来将路由的任务交给某台VRRP路由器的.</p>
<p><code>VRRP</code>通过竞选机制来实现虚拟路由器的功能,所有的协议报文都是通过IP多播(Multicast)包(默认的多播地址<code>224.0.0.18</code>)形式发送的<br> 虚拟路由器由VRID(范围0-255)和一组IP地址组成,对外表现为一个周知的MAC地址,:00-00-5E-00-01-{VRID}.<br> 所以,在一个虚拟路由器中,不管谁是Master,对外都是相同的MAC和IP(称之为VIP).<br> 客户端主机并不需要因Master的改变修改自己的路由配置.对它们来说,这种切换是透明的.</p>
<p>在一组虚拟路由器中,只有作为Master的VRRP路由器会一直发送VRRP广播包,此时Backup不会抢占Master<br> 当Master不可用时,Backup就收不到来自Master的广播包了,此时多台Backup中优先级最高的路由器会抢占为Master.<br> 这种抢占是非常快速的(可能只有1秒甚至更少),以保证服务的连续性,处于安全性考虑,VRRP数据包使用了加密协议进行了加密.</p>
<h3 id="2-3-面试的时候怎么说"><a href="#2-3-面试的时候怎么说" class="headerlink" title="2.3 面试的时候怎么说"></a>2.3 面试的时候怎么说</h3><p><code>keepalived</code>高可用对之间是通过<code>VRRP</code>通信的,因此,我从VRRP开始给您讲起.</p>
<ul>
<li>1)VRRP,全称Virtual Router Reduancy Protocol,中文名为虚拟路由器冗余协议,VRRP的出现是为了解决静态路由的单点故障,</li>
<li>2)VRRP是通过一种竞选协议来将路由任务交给某台VRRP路由器的,</li>
<li>3)VRRP用IP多播的方式,(默认多播地址(<code>224.0.0.18</code>))实现高可用对之间通信.</li>
<li>4)工作时主节点发包,备节点接包,当备节点接收不到主节点发的包的时候,就启动接管程序接管主节点的资源.备节点可以有多个,通过优先级竞选,但一般keepalived系统运维工作中都是一对.</li>
<li>5)VRRP使用了加密协议加密数据,但keepalived官方目前还是推荐用明文的方式配置认证类型和密码.</li>
</ul>
<p>介绍完了VRRP,接下来我在介绍一下keepalived服务的工作原理;<br>keepalived高可用对之间是通过VRRP进行通信的,VRRP是通过竞选机制来确定主备的,主的优先级高于备,因此,工作时会优先获得所有的资源,备节点处于等待状态,当主挂了的时候,备节点就会接管主节点的资源,然后顶替主节点对外提供服务.</p>
<p>在keepalived服务对之间,只有作为主的服务器会一直发送VRRP广播包,告诉备他还活着,此时备不会抢占主,当主不可用时,即备监听不到主发送的广播包时,就会启动相关服务接管资源,保证业务的连续性,接管速度最快可以小于一秒</p>
<h2 id="第3章-keepalived高可用服务搭建准备"><a href="#第3章-keepalived高可用服务搭建准备" class="headerlink" title="第3章 keepalived高可用服务搭建准备"></a>第3章 keepalived高可用服务搭建准备</h2><h3 id="3-1-安装keepalived环境说明"><a href="#3-1-安装keepalived环境说明" class="headerlink" title="3.1 安装keepalived环境说明"></a>3.1 安装keepalived环境说明</h3><p>这里使用前面已经搭建完成的Nginx负载均衡的系统环境来安装Keepalived服务,因为后面的实战案例是实现Nginx负载均衡的高可用案例.<br>安装Keepalived的基础准备环境如下:<br>准备5台物理服务器两台做Keepalived服务,3台做测试的web节点</p>
<p>Keepalived高可用实验环境准备</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>lb01-5</td>
<td>10.0.1.5</td>
<td>Keepalived主服务器(Nginx主负载均衡器)</td>
</tr>
<tr>
<td>lb02-6</td>
<td>10.0.1.6</td>
<td>Keepalived备服务器(Nginx备负载均衡器)</td>
</tr>
<tr>
<td>web01</td>
<td>10.0.1.7</td>
<td>web01服务器</td>
</tr>
<tr>
<td>web02</td>
<td>10.0.1.8</td>
<td>web02服务器</td>
</tr>
<tr>
<td>web03</td>
<td>10.0.1.9</td>
<td>web03服务器</td>
</tr>
</tbody></table>
<h3 id="3-2-安装keepalived软件"><a href="#3-2-安装keepalived软件" class="headerlink" title="3.2 安装keepalived软件"></a>3.2 安装keepalived软件</h3><p>注意:lb01和lb02都需要安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 ~]<span class="comment"># yum install keepalived -y</span></span><br><span class="line">[root@lb01-5 ~]<span class="comment"># rpm -qa keepalived</span></span><br><span class="line">keepalived-1.3.5-8.el7_6.x86_64</span><br><span class="line">[root@lb02 ~]<span class="comment"># yum install keepalived -y</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-启动keepalived服务并检查"><a href="#3-3-启动keepalived服务并检查" class="headerlink" title="3.3 启动keepalived服务并检查"></a>3.3 启动keepalived服务并检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 ~]<span class="comment"># systemctl start keepalived</span></span><br><span class="line">[root@lb01-5 ~]<span class="comment"># </span></span><br><span class="line">[root@lb01-5 ~]<span class="comment"># ps -ef |grep  keep</span></span><br><span class="line">root       1601      1  0 10:33 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">root       1602   1601  0 10:33 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">root       1603   1601  0 10:33 ?        00:00:03 /usr/sbin/keepalived -D</span><br><span class="line"><span class="comment">###提示:启动后有三个keepalived进程表示安装正确</span></span><br><span class="line">[root@lb01-5 ~]<span class="comment"># ip a|grep 192.168</span></span><br><span class="line">    inet 192.168.200.16/32 scope global eth0</span><br><span class="line">    inet 192.168.200.17/32 scope global eth0</span><br><span class="line">    inet 192.168.200.18/32 scope global eth0</span><br><span class="line"><span class="comment">###提示:默认情况会启动三个VIP地址</span></span><br><span class="line">[root@lb01-5 ~]<span class="comment"># systemctl stop keepalived</span></span><br><span class="line"><span class="comment">###提示: 测试完毕后关闭服务,上述测试需要在lb01和lb02两台服务器上进行</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-keepalived配置文件说明"><a href="#3-4-keepalived配置文件说明" class="headerlink" title="3.4 keepalived配置文件说明"></a>3.4 keepalived配置文件说明</h3><p>和其他yum安装的软件一样,keepalived软件的配置文件默认路径及配置文件名为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 ~]<span class="comment"># rpm -qc keepalived</span></span><br><span class="line">/etc/keepalived/keepalived.conf</span><br><span class="line">/etc/sysconfig/keepalived</span><br></pre></td></tr></table></figure>

<p>这里的具备高可用功能keepalived.conf配置文件包含了两个重要区块,下面分别说明:</p>
<p>(1)全局变量(Global Definitions)部分<br>这部分主要用来设置keepalived的故障通知机制和Router ID标识.示例配置如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># cat keepalived.conf.bak -n</span></span><br><span class="line">     1	! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">     2	</span><br><span class="line">     3	global_defs &#123;</span><br><span class="line">     4	   notification_email &#123;</span><br><span class="line">     5	     acassen@firewall.loc</span><br><span class="line">     6	     failover@firewall.loc</span><br><span class="line">     7	     sysadmin@firewall.loc</span><br><span class="line">     8	   &#125;</span><br><span class="line">     9	   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">    10	   smtp_server 192.168.200.1</span><br><span class="line">    11	   smtp_connect_timeout 30</span><br><span class="line">    12	   router_id LVS_DEVEL</span><br><span class="line">    13	   vrrp_skip_check_adv_addr</span><br><span class="line">    14	   vrrp_strict</span><br><span class="line">    15	   vrrp_garp_interval 0</span><br><span class="line">    16	   vrrp_gna_interval 0</span><br><span class="line">    17	&#125;</span><br></pre></td></tr></table></figure>

<p>基础参数说明:</p>
<ul>
<li>第1行是注释,!开头和#号开头一样,都是注释</li>
<li>第2行是空行</li>
<li>第3行~8行是定义故障服务报警的Email地址.作用是服务发生切换或RS节点等有故障时,需要发送的Email地址,可以有多个,每行一个.</li>
<li>第9行是制定发送邮件的发送人,即发送人地址,也是可选配置</li>
<li>第10行smtp_server指定发送邮件的smtp服务器,如果本机开启了sendmail或postfix.就可以使用上面默认配置实现邮件发送,也是可选配置.</li>
<li>第11行smtp_connect_timeout是连接smtp的超时时间,也是可选配置</li>
<li>第12行是Keepalived服务器的路由标识{route_id}.在一个局域网内,这个标识{route_id}应该是唯一的.</li>
<li>大括号{}.用来区分区块,要成对出现.如果楼写了半个大括号,keepalived运行时,不会报错,但是也不会得到预期的结果.另外,由于区块间存在多层嵌套关系,因此很容易遗漏区块结尾处的大括号,需要特别注意.</li>
</ul>
<p>(2)VRRP实例定义区域(VRRP instance(s))部分.<br> 这部分主要用来定义具体服务实例配置,包括Keepalived主备状态,接口,优先级,认证方式和IP信息等,配置如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">19	vrrp_instance VI_1 &#123;</span><br><span class="line">    20	    state MASTER</span><br><span class="line">    21	    interface eth0</span><br><span class="line">    22	    virtual_router_id 51</span><br><span class="line">    23	    priority 100</span><br><span class="line">    24	    advert_int 1</span><br><span class="line">    25	    authentication &#123;</span><br><span class="line">    26	        auth_type PASS</span><br><span class="line">    27	        auth_pass 1111</span><br><span class="line">    28	    &#125;</span><br><span class="line">    29	    virtual_ipaddress &#123;</span><br><span class="line">    30	        192.168.200.16</span><br><span class="line">    31	        192.168.200.17</span><br><span class="line">    32	        192.168.200.18</span><br><span class="line">    33	    &#125;</span><br><span class="line">    34	&#125;</span><br></pre></td></tr></table></figure>

<p>参数说明:</p>
<ul>
<li><p>第19行表示定义一个vrrp_instance实例,名字为VI_1,每个vrrp_instance实例可以认为是Keepalived服务的一个实例或者作为一个业务服务,在Keepalived服务配置中,这样的vrrp_instance实例可以有多个.注意,存在于主节点中的vrrp_isntance实例在备节点也要存在,这样才能实现故障切换接管.</p>
</li>
<li><p>第20行state MASTER表示当前示例VI_1的角色状态,当前角色为MASTER,这个状态只能有MASTER和BACKUP两种状态,并且需要大写这些字符.其中MASTER为正式工作的状态,BACKUP为备用的状态.当MASTER所在的服务器故障或失效时,BACKUP所在的服务器会接管故障的MASTER继续提供服务.</p>
</li>
<li><p>第21行interface为网路通信接口.为对外提供服务的网络接口,如eth0,eth1当前主流的服务器都有2~4个网络接口,在选择服务接口时,要搞清楚.</p>
</li>
<li><p>第22行virtual_router_id为虚拟路由ID标识,这个标识最好是一个数字</p>
</li>
<li><p>第23行priority为优先级,其后面的数值也是一个数字,数字越大,表示实例优先级越高.在同一个vrrp_instance实例里,MASTER的优先级配置要高于BACKUP的.若MASTER的priority值为150,那么BACKUP的priority必须小于150,一般建议隔50以上为佳.</p>
</li>
<li><p>第24行advent_int为同步通知间隔.MASTER与BACKUP之间通信检查的时间间隔,默认为1秒.</p>
</li>
<li><p>第25-27行authentication为权限认证配置.包含认证类型(auth_type)和认证密码(auth_pass)认证类型有PASS(simple passwd),AH(IPSEC)两种,官方推荐使用的类型为PASS.验证密码为明文方式,最好长度不能超过8个字符,建议四位数字,同一vrrp实例的MASTER与BACKUP使用相同的密码才能正常通信.</p>
</li>
<li><p>第29-32行virtual_ipaddress为虚拟IP地址.可以配置多个IP地址,每个地址占一行,配置时最好明确指定子网掩码以及虚拟IP绑定的网络接口.否则,子网掩码默认是32位,绑定的接口和前面的interface参数配置的一致.注意,这里的虚拟IP就是在工作中需要和域名绑定的IP,即和配置的高可用服务监听的IP要保持一致.</p>
</li>
</ul>
<h2 id="第4章-配置keepalived实现单IP自动漂移接管"><a href="#第4章-配置keepalived实现单IP自动漂移接管" class="headerlink" title="第4章 配置keepalived实现单IP自动漂移接管"></a>第4章 配置keepalived实现单IP自动漂移接管</h2><p>实际上可以将高可用对的两台机器应用服务同时开启,但是只让VIP一段的服务器提供服务,若主的服务器宕机,VIP会自动漂移到备用服务器,此时用户的请求直接发送到备用服务器上,而无须临时启动对应服务(事先开启应用服务).下面来讲解VIP自动漂移实战案例.</p>
<h3 id="4-1-实战配置keepalived主服务器lb01-MASTER"><a href="#4-1-实战配置keepalived主服务器lb01-MASTER" class="headerlink" title="4.1 实战配置keepalived主服务器lb01 MASTER"></a>4.1 实战配置keepalived主服务器lb01 MASTER</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># cat keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完毕后,启动keepalived服务,如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># systemctl start keepalived</span></span><br></pre></td></tr></table></figure>

<p>然后检查配置结果,查看是否有虚拟IP 10.0.0.3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># ip addr|grep 10.0.1.3</span></span><br><span class="line">    inet 10.0.1.3/32 scope global eth0</span><br></pre></td></tr></table></figure>

<p>出现上述带有vip:10.0.0.3行的结果表示lb01的keepalived服务单实例配置成功.</p>
<h3 id="4-2-实战配置keepalived备服务器lb02-BACKUP"><a href="#4-2-实战配置keepalived备服务器lb02-BACKUP" class="headerlink" title="4.2 实战配置keepalived备服务器lb02 BACKUP"></a>4.2 实战配置keepalived备服务器lb02 BACKUP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完毕,启动keepalived服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment"># systemctl start keepalived</span></span><br></pre></td></tr></table></figure>

<p>然后检查配置结果,查看是否有虚拟IP 10.0.0.3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment"># ip addr|egrep 10.0.1.3</span></span><br></pre></td></tr></table></figure>

<p>这里没有返回任何结果就对了,因为lb02为BACKUP,当主节点活着的时候,他不会接管VIP 10.0.1.3</p>
<p>出现上述无任何结果的现象,表示lb02的keepailved服务单实例配置成功.如果lv02的配置过滤后有10.0.1.3的IP,则表示keepalived工作不正,同一个IP地址同一时刻应该只能出现在一台服务器上.</p>
<p>如果查看BACKUP备节点VIP有,说明高可用裂脑了,裂脑是两台服务器争抢统一资源导致的,例如:两边都配置了同一个VIP地址.</p>
<h3 id="4-3-出现裂脑后的排查"><a href="#4-3-出现裂脑后的排查" class="headerlink" title="4.3 出现裂脑后的排查"></a>4.3 出现裂脑后的排查</h3><p>出现上述两台服务器争抢同一IP资源问题,一般要先考虑排查两个地方:</p>
<p>(1)主备两台服务器之间是否通讯正常,如果不正常是否有iptables防火墙阻挡?</p>
<p>(2)主备两台服务器对应的keepalived.conf配置文件是否有错误?例如是否同一实例的virtual_router_id配置不一样.</p>
<h3 id="4-4-进行高可用主备服务器切换"><a href="#4-4-进行高可用主备服务器切换" class="headerlink" title="4.4 进行高可用主备服务器切换"></a>4.4 进行高可用主备服务器切换</h3><p>停掉主服务器上的keepalived服务或关闭主服务器,操作并检查步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># ip addr|grep 10.0.1.3</span></span><br><span class="line">    inet 10.0.1.3/32 scope global eth0</span><br><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># systemctl stop keepalived.service</span></span><br><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># ip addr|grep 10.0.1.3</span></span><br></pre></td></tr></table></figure>

<p>可以看到VIP 10.0.0.3消失了,此时查看BACKUP备服务器,看是否会有VIP 10.0.0.3出现,操作及检查步骤如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment"># ip addr|grep 10.0.1.3</span></span><br><span class="line">    inet 10.0.1.3/32 scope global eth0</span><br></pre></td></tr></table></figure>

<p>可以看到备节点lb02已经接管绑定了10.0.1.3这个VIP,这期间备节点还会发送ARP广播,让所有的客户端更新本地的ARP表,以便客户端访问接管VIP服务的节点.</p>
<p>此时如果再启动主服务器的keepalived服务,主服务器就会接管回VIP 10.0.1.3启动后可以观察下主备的IP漂移情况,备服务器是否释放了IP?主服务器是否又接管了IP ?</p>
<p>主节点启动keepalived服务后,发现很快就又接管了VIP 10.0.1.3,操作及检查步骤如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># systemctl start keepalived.service </span></span><br><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># ip addr|grep 10.0.1.3</span></span><br><span class="line">    inet 10.0.1.3/32 scope global eth0</span><br></pre></td></tr></table></figure>

<p>与此同时,备节点上的VIP 10.0.0.3则被释放了,如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment"># ip addr|grep 10.0.1.3</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-单实例主备模式keeplibed配置文件对比"><a href="#4-5-单实例主备模式keeplibed配置文件对比" class="headerlink" title="4.5 单实例主备模式keeplibed配置文件对比"></a>4.5 单实例主备模式keeplibed配置文件对比</h3><p>可以看到,上述keepalived单实例MASTER和BACKUP节点的配置差别项,只有3项是不同的</p>
<table>
<thead>
<tr>
<th>Keepalived配置参数</th>
<th>MASTER节点特殊参数</th>
<th>BACKUP节点特殊参数</th>
</tr>
</thead>
<tbody><tr>
<td>router_id(唯一标识)</td>
<td>router_id lb01</td>
<td>router_id lb02</td>
</tr>
<tr>
<td>state(角色状态)</td>
<td>state MASTER</td>
<td>state BACKUP</td>
</tr>
<tr>
<td>priority(竞选优先级)</td>
<td>priority 100</td>
<td>priority 50</td>
</tr>
</tbody></table>
<h2 id="第5章-keepalived高可用服务器的裂脑问题"><a href="#第5章-keepalived高可用服务器的裂脑问题" class="headerlink" title="第5章 keepalived高可用服务器的裂脑问题"></a>第5章 keepalived高可用服务器的裂脑问题</h2><h3 id="5-1-什么是裂脑"><a href="#5-1-什么是裂脑" class="headerlink" title="5.1 什么是裂脑"></a>5.1 什么是裂脑</h3><p>由于某些原因,导致两台高可用服务器对在指定时间内,无法检测到对方的心跳消息,各自取得资源及服务</p>
<p>的所有权,而此时的两台高可用服务器都还活着并在正常运行,这样就会导致同一个IP或服务在两端同时</p>
<p>存在而发生冲突,最严重的是两台服务器占用同一个VIP地址,当用户写入数据时可能会分别写入到两端,</p>
<p>这可能会导致服务器两端的数据不一致或造成数据丢失,这种情况就被成为裂脑.</p>
<h3 id="5-2-导致裂脑发生的原因"><a href="#5-2-导致裂脑发生的原因" class="headerlink" title="5.2 导致裂脑发生的原因"></a>5.2 导致裂脑发生的原因</h3><p>一般来说,裂脑的发生,有以下几种原因<br>   高可用服务器对之间心跳线链路发生故障,导致无法正常通信<br>   心跳线坏了(包括断了,老化)<br>   网卡及相关驱动坏了,IP配置及冲突问题(网卡直连)<br>   心跳线之间连接的设备故障(网卡及交换机)<br>   仲裁的机器出问题了(采用总裁的方案)<br>   高可用服务器上开启了iptables防火墙阻挠了心跳信息传输<br>   高可用服务器上心跳网卡地址等信息配置不正确,导致发送心跳失败<br>   其他服务配置不当等原因,如心跳方式不同,心跳广播冲突,软件bug等.</p>
<h3 id="5-3-解决裂脑的常见方法"><a href="#5-3-解决裂脑的常见方法" class="headerlink" title="5.3 解决裂脑的常见方法"></a>5.3 解决裂脑的常见方法</h3><p>在实际成产环境中,我们可以从以下几个方面来防止裂脑问题发生:</p>
<p>同时使用串行电缆和以太网电缆连接,同时用两条心跳线,这样一条线路坏了,另一个还是好的,依然能传送心跳信息.</p>
<p>当检测到裂脑时强行关闭一个心跳节点(这个功能需要特殊设备支持,如stonith,fence)相当于备节点接收不到心跳信息,通过单独的线路发送命令关闭主节点的电源.</p>
<p>做好对裂脑的监控报警(如邮件及手机短信等或值班),在问题发生时人为第一时间介入仲裁,降低损失.</p>
<h3 id="5-4-解决keepalived裂脑的常见方案"><a href="#5-4-解决keepalived裂脑的常见方案" class="headerlink" title="5.4 解决keepalived裂脑的常见方案"></a>5.4 解决keepalived裂脑的常见方案</h3><p>作为互联网应用服务器的高可用,特别是前端web负载均衡器的高可用,裂脑的问题对普遍业务的影响是可容忍的,如果是数据库或者存储的业务,一般出现裂脑问题就非常严重了.因此,通过增加冗余心跳线来避免裂脑问题发生,同时加强了对系统的监控.</p>
<p>如果开启防火墙,一定要让心跳消息通过.一般通过允许IP段的形式解决<br> 可以拉一条以太网网线或者串口线作为主备节点心跳线路的冗余<br> 开发检测程序通过监控软件检测裂脑,如zabbix检测如果主备都有VIP就报警.<br> 比较严谨的判断,备节点出现对应VIP,并且主节点及对应服务(如果能远程连接主节点看是否有VIP就更好了)还活着,就说明发生裂脑了.</p>
<p>具体监控系统裂脑的脚本见文章结尾”开发检测keepalived裂脑的脚本”</p>
<h3 id="5-5-模拟keepalived裂脑场景"><a href="#5-5-模拟keepalived裂脑场景" class="headerlink" title="5.5 模拟keepalived裂脑场景"></a>5.5 模拟keepalived裂脑场景</h3><p>抓包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -nn -c 20 -i any host 224.0.0.18</span><br></pre></td></tr></table></figure>

<p>开启防火墙 firewalld</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment"># firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface eth0 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span></span><br></pre></td></tr></table></figure>

<p>iptables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -i eth0 -d 224.0.0.0/8 -p vrrp -j ACCEPT</span><br><span class="line">iptables -I OUTPUT -o eth0 -d 224.0.0.0/8 -p vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>再次抓包查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -nn -c 20 -i any host 224.0.0.18</span><br></pre></td></tr></table></figure>

<h2 id="第6章-Nginx负载均衡配合keepalived双主模式实战"><a href="#第6章-Nginx负载均衡配合keepalived双主模式实战" class="headerlink" title="第6章 Nginx负载均衡配合keepalived双主模式实战"></a>第6章 Nginx负载均衡配合keepalived双主模式实战</h2><p>结合前面介绍的Nginx负载均衡的环境,调整好住负载均衡器lb01,备用负载均衡器lb02服务器上Nginx负载均衡环境,两台服务器的安装基础环境一模一样.</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>lb01-5</td>
<td>10.0.1.5</td>
<td>VIP:10.0.1.2(用于绑定A服务<a href="http://www.oldboy.com域名" target="_blank" rel="noopener">www.oldboy.com域名</a>)</td>
</tr>
<tr>
<td>lb02-6</td>
<td>10.0.1.6</td>
<td>VIP:10.0.1.3(用于绑定B服务zh.oldboy.com域名)</td>
</tr>
<tr>
<td>web01-7</td>
<td>10.0.1.7</td>
<td>Nginx web服务器1</td>
</tr>
<tr>
<td>web02-8</td>
<td>10.0.1.8</td>
<td>Nginx web 服务器2</td>
</tr>
</tbody></table>
<h3 id="6-1-配置keepalived双主"><a href="#6-1-配置keepalived双主" class="headerlink" title="6.1 配置keepalived双主"></a>6.1 配置keepalived双主</h3><p>lb01配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># cat keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb01-5 /etc/keepalived]<span class="comment"># systemctl restart keepalived.service</span></span><br></pre></td></tr></table></figure>

<p>lb02配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb02-6 ~]<span class="comment"># systemctl restart keepalived.service</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-Nginx负载均衡"><a href="#6-2-Nginx负载均衡" class="headerlink" title="6.2 Nginx负载均衡"></a>6.2 Nginx负载均衡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /etc/nginx/conf.d]<span class="comment"># cat 01-www.conf</span></span><br><span class="line">upstream server_pools &#123;</span><br><span class="line">        server 10.0.1.7;</span><br><span class="line">        server 10.0.1.8;</span><br><span class="line">        server 10.0.1.9;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 10.0.1.3:80;</span><br><span class="line">    server_name blog.oldboy.com;</span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/blog.access.log  main;</span><br><span class="line">    location / &#123; </span><br><span class="line">        proxy_pass http://server_pools;</span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 10.0.1.2:80;</span><br><span class="line">    server_name zh.oldboy.com;</span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/zh.access.log  main;</span><br><span class="line">    location / &#123; </span><br><span class="line">        proxy_pass http://server_pools;</span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-重启nginx和keepalived"><a href="#6-3-重启nginx和keepalived" class="headerlink" title="6.3 重启nginx和keepalived"></a>6.3 重启nginx和keepalived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart keepalived</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<h3 id="6-4-配置windows解析"><a href="#6-4-配置windows解析" class="headerlink" title="6.4 配置windows解析"></a>6.4 配置windows解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.0.1.3 blog.oldboy.com</span><br><span class="line">10.0.1.2 zh.oldboy.com</span><br></pre></td></tr></table></figure>

<h3 id="6-5-访问测试"><a href="#6-5-访问测试" class="headerlink" title="6.5 访问测试"></a>6.5 访问测试</h3><h3 id="6-6-模拟keepalived故障"><a href="#6-6-模拟keepalived故障" class="headerlink" title="6.6 模拟keepalived故障"></a>6.6 模拟keepalived故障</h3><p>此时停掉lb01服务器或停止keepalived服务器，观察结果是否正常<br>然后观察lb02备点是否接管了VIP 10.0.1.3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 ~]<span class="comment"># systemctl stop keepalived.service</span></span><br><span class="line">[root@lb02-6 /etc/nginx/conf.d]<span class="comment"># ip addr|grep 10.0.1</span></span><br><span class="line">    inet 10.0.1.6/24 brd 10.0.1.255 scope global eth0</span><br><span class="line">    inet 10.0.1.2/32 scope global eth0</span><br><span class="line">    inet 10.0.1.3/32 scope global eth0</span><br></pre></td></tr></table></figure>

<h3 id="6-7-恢复lb01的keelived服务"><a href="#6-7-恢复lb01的keelived服务" class="headerlink" title="6.7 恢复lb01的keelived服务"></a>6.7 恢复lb01的keelived服务</h3><p>查看是否恢复正常</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 ~]<span class="comment"># systemctl start keepalived.service </span></span><br><span class="line">[root@lb01-5 ~]<span class="comment"># ip addr|grep 10.0.1</span></span><br><span class="line">    inet 10.0.1.5/24 brd 10.0.1.255 scope global eth0</span><br><span class="line">    inet 10.0.1.3/32 scope global eth0</span><br><span class="line">[root@lb02-6 /etc/nginx/conf.d]<span class="comment"># ip addr|grep 10.0.1</span></span><br><span class="line">    inet 10.0.1.6/24 brd 10.0.1.255 scope global eth0</span><br><span class="line">    inet 10.0.1.2/32 scope global eth0</span><br></pre></td></tr></table></figure>

<h2 id="第7章-开发监控keepalived裂脑的脚本"><a href="#第7章-开发监控keepalived裂脑的脚本" class="headerlink" title="第7章  开发监控keepalived裂脑的脚本"></a>第7章  开发监控keepalived裂脑的脚本</h2><p>检测思路,VIP什么时候 什么条件 才会飘走<br>由于某些原因，导致两台 keepalived 高可用服务器在指定时间内，无法检测到对方的心跳消息，各自取得资源及服务的所有权，而此时的两台高可用服务器又都还活着。<br>服务器网线松动等网络故障<br>服务器硬件故障发生损坏现象而崩溃<br>主备都开启 firewalld 防火墙<br>Nginx 服务死掉等</p>
<h3 id="7-1-lb01检查web脚本"><a href="#7-1-lb01检查web脚本" class="headerlink" title="7.1 lb01检查web脚本"></a>7.1 lb01检查web脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 ~]<span class="comment"># mkdir /server/scripts -p</span></span><br><span class="line">[root@lb01-5 /server/scripts]<span class="comment"># cat check_web.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">nginxpid=$(ps -C nginx --no-header|wc -l)</span><br><span class="line"><span class="comment">#1.判断 Nginx 是否存活,如果不存活则尝试启动 Nginx</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$nginxpid</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl start nginx</span><br><span class="line">    sleep 3</span><br><span class="line">    <span class="comment">#2.等待 3 秒后再次获取一次 Nginx 状态</span></span><br><span class="line">    nginxpid=$(ps -C nginx --no-header|wc -l)</span><br><span class="line">    <span class="comment">#3.再次进行判断, 如 Nginx 还不存活则停止 Keepalived,让地址进行漂移,并退出脚本</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$nginxpid</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        systemctl stop keepalived</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>keepalived配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01-5 /server/scripts]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_web &#123;</span><br><span class="line">    script <span class="string">"/server/scripts/check_web.sh"</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight 50</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.2</span><br><span class="line">    &#125;</span><br><span class="line">      track_script &#123;</span><br><span class="line">        check_web</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-lb02脚本"><a href="#7-2-lb02脚本" class="headerlink" title="7.2 lb02脚本"></a>7.2 lb02脚本</h3><p>检查vip脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 ~]<span class="comment">#  mkdir /server/scripts -p</span></span><br><span class="line">[root@lb02-6 /server/scripts]<span class="comment"># cat check_backup_keep.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">lb01_vip=10.0.1.3</span><br><span class="line">lb01_nginx=$(curl -x 10.0.1.5:80 -I -s -w <span class="string">"%&#123;http_code&#125;\n"</span> -o /dev/null  blog.oldzhang.com)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ping -c 1 -W 1 $&#123;lb01_ip&#125; &amp;&gt;/dev/null</span></span><br><span class="line"><span class="comment">#如果lb01的IP能ping通,但是我自己也存在VIP,我就认为发生裂脑了,我就把自己的keep干掉</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;lb01_nginx&#125;</span> -eq 200 -a `ip add|grep <span class="string">"<span class="variable">$lb01_vip</span>"</span>|wc -l` -eq 1 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ha is bad"</span> &gt;&gt; /tmp/check.txt</span><br><span class="line">    systemctl stop keepalived</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ha is ok"</span> &gt;&gt; /tmp/check.txt</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>keepalived配置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02-6 /server/scripts]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_backup_keep &#123;</span><br><span class="line">    script <span class="string">"/server/scripts/check_backup_keep.sh"</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight 50</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.1.2</span><br><span class="line">    &#125;</span><br><span class="line">     track_script &#123;</span><br><span class="line">     check_backup_keep</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Wu Fei</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://linuxwf.com/2020/04/13/15-keepalived/">http://linuxwf.com/2020/04/13/15-keepalived/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://linuxwf.com" target="_blank">WF's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/keepalived/">keepalived</a></div><div class="post_share"><div class="social-share" data-image="/img/wallhaven-2714.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/13/16-HTTPS%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6/"><img class="prev_cover lazyload" data-src="/img/wallhaven-435555.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">16.HTTPS域名证书</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/13/14-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"><img class="next_cover lazyload" data-src="/img/wallhaven-153272.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">14.反向代理负载均衡</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: true,
  verify: false,
  appId: 'mJGbzahn0dOntrhO5Hek8Rjd-gzGzoHsz',
  appKey: 'b0O75eIR8ULkl2kyDWLgLXM0',
  placeholder: 'Please leave your footprints',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-cn',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" style="background-image: url(/img/63060960_p0.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Wu Fei</div><div class="footer_custom_text">Hi, welcome to my <a href="https://www.linuxwf.com/" target="_blank" rel="noopener">blog</a></div><div class="icp"><a href="http://beian.miit.gov.cn" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"/><span>粤ICP备19138449号-1</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/algolia.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":100,"vOffset":-50},"mobile":{"show":true,"scale":0.5}});</script></body></html>